<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo de prueba- [Prueba]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      
      // Hacemos que las funciones de Firebase estén disponibles globalmente
      window.initializeApp = initializeApp;
      window.getFirestore = getFirestore;
      window.collection = collection;
      window.doc = doc;
      window.setDoc = setDoc;
      window.deleteDoc = deleteDoc;
      window.onSnapshot = onSnapshot;
      window.query = query;
      window.where = where;
      window.getDoc = getDoc;
      window.getAuth = getAuth;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.onAuthStateChanged = onAuthStateChanged;

      // Configuraciones de Tailwind
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.5s ease-out',
              'fade-in': 'fadeIn 0.5s ease-out',
              // Animación para el gradiente
              'bg-gradient': 'gradientShift 15s ease infinite',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: 0, transform: 'translateY(10px)' },
                '100%': { opacity: 1, transform: 'translateY(0)' },
              },
              fadeIn: {
                '0%': { opacity: 0 },
                '100%': { opacity: 1 },
              },
              // Keyframes para el gradiente animado
              gradientShift: {
                '0%': { 'background-position': '0% 50%' },
                '50%': { 'background-position': '100% 50%' },
                '100%': { 'background-position': '0% 50%' },
              },
            }
          },
        }
      }
    </script>

    <style>
        /* Estilos de Fondo Animado: BOLAS DE BINGO Y GRADIENTE */
        
        /* 1. Contenedor principal para el gradiente */
        .gradient-background {
            /* Colores predeterminados: Puedes cambiarlos aquí */
            background: linear-gradient(-45deg, #0E1086, #480E86, #840E86, #ED47F0);
            background-size: 400% 400%; /* Permite el movimiento del gradiente */
            animation: bg-gradient 15s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Detrás de todo el contenido */
            opacity: 3.0; /* Suaviza el efecto para no distraer */
        }
        
        /* 2. Contenedor de las bolas de bingo */
        .bingo-bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1; /* Encima del gradiente, debajo del contenido */
        }

        .bingo-bubbles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            animation: moveBubbles 25s linear infinite;
            bottom: -150px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Variaciones para hacer el efecto más orgánico */
        .bingo-bubbles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .bingo-bubbles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .bingo-bubbles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .bingo-bubbles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .bingo-bubbles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .bingo-bubbles li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .bingo-bubbles li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .bingo-bubbles li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .bingo-bubbles li:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .bingo-bubbles li:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }


        @keyframes moveBubbles {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        /* Estilos de impresión y carga */
        @media print {
            body * { visibility: hidden; }
            #root, #root * { visibility: visible; }
            #root { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print, footer, .gradient-background, .bingo-bubbles { display: none !important; }
            .bingo-grid { width: 100%; }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 font-sans relative">
    
    <div class="gradient-background"></div>

    <ul class="bingo-bubbles">
        <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
    </ul>

    <div id="root" class="relative z-10">
        <div class="h-screen flex items-center justify-center">
            <div class="spinner"></div>
            <p class="ml-4 text-lg text-slate-600">Cargando Bingo Master...</p>
        </div>
    </div>

    <script type="text/babel">
    const { useState, useEffect, createElement } = React;
    
    /**
     * ------------------------------------------------------------------
     * CONFIGURACIÓN DE FIREBASE (¡IMPORTANTE! ESTA SECCIÓN SE EDITA)
     * ------------------------------------------------------------------
     */
    const firebaseConfig = {
      // ** REEMPLAZAR AQUÍ CON LA CONFIGURACIÓN DEL NUEVO CLIENTE **
  apiKey: "AIzaSyDFb0RHclfJmjhIk1XlLexP_7JI2fqtY-U",
  authDomain: "bingodeprueba.firebaseapp.com",
  databaseURL: "https://bingodeprueba-default-rtdb.firebaseio.com",
  projectId: "bingodeprueba",
  storageBucket: "bingodeprueba.firebasestorage.app",
  messagingSenderId: "885689596908",
  appId: "1:885689596908:web:6c2572f26d672771d01ec9"
      // ** FIN DEL BLOQUE DE CONFIGURACIÓN DEL CLIENTE **
    };

    // Inicializamos Firebase y obtenemos las instancias de DB y Auth
    // Usamos las variables globales cargadas por el script type="module"
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // =========================================================================
    //  ⚡️ CONFIGURACIÓN: URL BASE DE LAS IMÁGENES ⚡️
    // =========================================================================
    // CORREGIDO: Se cambió 'main' por 'principal' según tu repositorio
    const BINGO_CARDS_BASE_URL = 'https://raw.githubusercontent.com/bingodeprueba/bingodeprueba/principal/cartas/'; 
    
    // Función para construir la URL de la imagen
    const getCardImageUrl = (playerId) => {
        // Formato: cartas/carta001.jpg
        const cardName = `carta${playerId}.jpg`;
        return `${BINGO_CARDS_BASE_URL}${cardName}`;
    };
    // =========================================================================

    // Lucide Icons (se importan como componentes React)
    const Search = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('circle', { cx: 11, cy: 11, r: 8 }), createElement('path', { d: "m21 21-4.3-4.3" }));
    const UserPlus = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), createElement('circle', { cx: 9, cy: 7, r: 4 }), createElement('line', { x1: 19, y1: 8, x2: 19, y2: 14 }), createElement('line', { x1: 22, y1: 11, x2: 16, y2: 11 }));
    const Trash2 = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M3 6h18" }), createElement('path', { d: "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" }), createElement('path', { d: "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" }), createElement('line', { x1: 10, y1: 11, x2: 10, y2: 17 }), createElement('line', { x1: 14, y1: 11, x2: 14, y2: 17 }));
    const LogOut = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), createElement('polyline', { points: "16 17 21 12 16 7" }), createElement('line', { x1: 21, y1: 12, x2: 9, y2: 12 }));
    const Check = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('polyline', { points: "20 6 9 17 4 12" }));
    // Se elimina Sparkles
    const Hash = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('line', { x1: 4, y1: 9, x2: 20, y2: 9 }), createElement('line', { x1: 4, y1: 15, x2: 20, y2: 15 }), createElement('line', { x1: 10, y1: 3, x2: 8, y2: 21 }), createElement('line', { x1: 16, y1: 3, x2: 14, y2: 21 }));
    const X = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M18 6 6 18" }), createElement('path', { d: "m6 6 12 12" }));
    const Printer = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('polyline', { points: "6 9 6 2 18 2 18 9" }), createElement('path', { d: "M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" }), createElement('rect', { width: 12, height: 8, x: 6, y: 14 }), createElement('line', { x1: 12, y1: 14, x2: 12, y2: 22 }));
    const Lock = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('rect', { width: 18, height: 11, x: 3, y: 11, rx: 2, ry: 2 }), createElement('path', { d: "M7 11V7a5 5 0 0 1 10 0v4" }));
    const Loader2 = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M21 12a9 9 0 1 1-6.219-8.56" }));
    const Download = (props) => createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", className: props.className || "" }, createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), createElement('polyline', { points: "7 10 12 15 17 10" }), createElement('line', { x1: 12, y1: 15, x2: 12, y2: 3 }));


    /**
     * LOGICA DEL BINGO (Ahora Eliminada, solo se mantendrá la estructura para setDoc)
     */
    const generateBingoMatrix = () => {
      // ESTA FUNCIÓN AHORA DEVUELVE UN VALOR FICTICIO (null), ya que la data de las cartas 
      // se gestiona con la ID y la imagen externa.
      return null;
    };


    /**
     * COMPONENTES VISUALES
     */
     
    // ⚡️ COMPONENTE FULL TICKET MEJORADO PARA MOSTRAR IMAGEN ⚡️
    const FullTicket = ({ player }) => {
      // Asegurar que player exista
      if (!player) return null;

      const cardUrl = getCardImageUrl(player.id);
      const downloadFileName = `Bingo_Ticket_${player.id}_${player.name.replace(/\s/g, '_')}.jpg`; 

      // ✨ FUNCIÓN CLAVE PARA DESCARGA EN MÓVILES (Blob) ✨
      const handleDownloadImage = async () => {
          try {
              // 1. Obtener la imagen como un Blob
              const response = await fetch(cardUrl);
              const blob = await response.blob();
              
              // 2. Crear una URL de objeto temporal
              const url = window.URL.createObjectURL(blob);
              
              // 3. Crear un elemento 'a' para simular el clic de descarga
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = url;
              a.download = downloadFileName; // Nombre del archivo

              // 4. Agregar, hacer clic y remover el elemento 'a'
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url); // Liberar la URL temporal
              document.body.removeChild(a);

          } catch (error) {
              console.error('Error al descargar la imagen:', error);
              document.getElementById('modal-message').innerText = '❌ Error al intentar descargar la imagen.';
              document.getElementById('error-modal').classList.remove('hidden');
              setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
      };
      // ----------------------------------------------------


      // Simplemente mostramos la imagen basándonos en el ID del jugador
      return (
        <div id="bingo-ticket-export" className="bg-white p-4 sm:p-6 rounded-3xl shadow-2xl max-w-3xl mx-auto border-t-8 border-purple-600 relative overflow-hidden">
          <div className="text-center mb-6 relative z-10">
            <div className="inline-flex items-center justify-center gap-2 bg-puple-100 text-purple-700 px-4 py-1 rounded-full text-sm font-bold mb-2">
              <Hash size={14} /> TICKET #{player.id}
            </div>
            <h2 className="text-3xl sm:text-4xl font-black text-slate-800 uppercase">BINGO <span className="text-purple-600">DE PRUEBA</span></h2>
            <p className="text-slate-500 font-medium text-lg mt-1 uppercase">{player.name}</p>
          </div>
          <div className="relative z-10 flex flex-col items-center justify-center">
             <div className="bg-slate-100 p-2 rounded-xl shadow-inner border border-slate-200">
               <img 
                   src={cardUrl} 
                   alt={`Cartón de Bingo #${player.id}`} 
                   className="max-w-full h-auto rounded-lg shadow-md"
               />
             </div>
             {/* Botón de Descarga MODIFICADO */}
             <button 
                 onClick={handleDownloadImage}
                 className="mt-4 bg-green-500 text-white px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-green-600 transition-colors no-print"
             >
                 <Download size={20} /> Descargar Cartón
             </button>
          </div>
          <div className="mt-6 pt-4 border-t border-dashed border-slate-300 flex justify-between items-center text-xs text-slate-400">
            <span>Bingo de prueba</span>
            <span className="flex items-center gap-1"><Check size={12} /> Verificado</span>
          </div>
        </div>
      );
    };

    /**
     * APP PRINCIPAL
     */
    const App = () => {
      const [activeTab, setActiveTab] = useState('home'); 
      const [players, setPlayers] = useState([]);
      const [searchCode, setSearchCode] = useState('');
      const [foundPlayer, setFoundPlayer] = useState(null);
      
      // Auth States
      const [user, setUser] = useState(null);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [authError, setAuthError] = useState('');

      // Admin Action States
      const [newName, setNewName] = useState('');
      const [newId, setNewId] = useState('');
      const [loading, setLoading] = useState(false);
      const [actionLoading, setActionLoading] = useState(false);

      // 1. Escuchar Autenticación
      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
        });
        return () => unsubscribe();
      }, []);

      // 2. Escuchar Base de Datos (Solo si es admin, para ahorrar lecturas)
      useEffect(() => {
        if (user && activeTab === 'admin') {
          try {
            const q = query(collection(db, "players"));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
              const playersList = [];
              querySnapshot.forEach((doc) => {
                // El campo 'grids' sigue existiendo pero ahora es nulo
                playersList.push({ id: doc.id, ...doc.data() }); 
              });
              // Ordenar por ID
              playersList.sort((a, b) => parseInt(a.id) - parseInt(b.id));
              setPlayers(playersList);
              
              // Calcular siguiente ID
              if(playersList.length > 0) {
                  const lastId = Math.max(...playersList.map(p => parseInt(p.id)));
                  setNewId(String(lastId + 1).padStart(3, '0'));
              } else {
                  setNewId('001');
              }
            });
            return () => unsubscribe();
          } catch (e) {
            console.error("Error al suscribirse a Firestore:", e);
            setAuthError("Error de conexión con la base de datos. Revisa la consola o las reglas de seguridad.");
            return () => {}; 
          }
        } else {
            setPlayers([]); // Limpiar si no es admin
            return () => {};
        }
      }, [user, activeTab]);

      // --- MÉTODOS ---

      const handleSearch = async (e) => {
        e.preventDefault();
        // El ID debe ser un número de 3 dígitos (ej: '001')
        const formattedCode = searchCode.padStart(3, '0');
        if(!formattedCode || formattedCode.length > 3) return;
        setLoading(true);
        setFoundPlayer(null);

        try {
          const docRef = doc(db, "players", formattedCode);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            setFoundPlayer(docSnap.data());
            setActiveTab('result');
          } else {
             document.getElementById('modal-message').innerText = '❌ No encontramos ese número de cartón.';
             document.getElementById('error-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
        } catch (error) {
          console.error("Error buscando:", error);
           document.getElementById('modal-message').innerText = "Error de conexión. Intenta más tarde.";
           document.getElementById('error-modal').classList.remove('hidden');
           setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
        }
        setLoading(false);
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setAuthError('');
        setLoading(true);
        try {
          await signInWithEmailAndPassword(auth, email, password);
          setActiveTab('admin');
        } catch (error) {
          setAuthError('Credenciales incorrectas o usuario no existe. Revisa tu email y contraseña.');
        }
        setLoading(false);
      };

      const handleLogout = async () => {
        await signOut(auth);
        setActiveTab('home');
      };

      // ⚡️ Lógica de creación simplificada. Ya no genera números. ⚡️
      const handleCreatePlayer = async (e) => {
        e.preventDefault();
        const formattedId = newId.padStart(3, '0');
        if(!newName || !formattedId) return;
        setActionLoading(true);

        try {
          // Verificar si el ID ya existe
          const docRef = doc(db, "players", formattedId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists() && !window.confirm(`El cartón #${formattedId} ya existe para ${docSnap.data().name}. ¿Quieres sobrescribirlo?`)) {
              setActionLoading(false);
              return;
          }

          // Usamos setDoc para definir nosotros el ID del documento (ej: "001")
          await setDoc(docRef, {
            id: formattedId,
            name: newName,
            createdAt: new Date().toISOString(),
            // Se mantiene el campo 'grids' (aunque es nulo) para no romper la estructura de datos,
            // pero su valor ya no es relevante. La carta es la imagen externa.
            grids: [generateBingoMatrix(), generateBingoMatrix()] 
          });
          setNewName('');
          
          document.getElementById('modal-message').innerText = `✅ Cartón #${formattedId} asignado a ${newName}.`;
          document.getElementById('error-modal').classList.remove('hidden');
          setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 5000);
          
        } catch (error) {
          console.error("Error creando:", error);
           document.getElementById('modal-message').innerText = "Error al guardar en base de datos. Revisa las reglas de 'write'.";
           document.getElementById('error-modal').classList.remove('hidden');
           setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 5000);
        }
        setActionLoading(false);
      };

      const handleDelete = async (id) => {
        if(window.confirm(`¿Estás seguro de borrar el cartón #${id}?`)) {
          try {
            await deleteDoc(doc(db, "players", id));
          } catch (error) {
             document.getElementById('modal-message').innerText = "Error al eliminar. Revisa las reglas de seguridad.";
             document.getElementById('error-modal').classList.remove('hidden');
             setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
        }
      };

      const handlePrint = () => window.print();
      
      // ✨ FUNCIÓN PARA DESCARGA DIRECTA DESDE EL PANEL ADMIN ✨
      const handleDownloadAdmin = async (id, name) => {
          const cardUrl = getCardImageUrl(id);
          const downloadFileName = `Bingo_Ticket_${id}_${name.replace(/\s/g, '_')}.jpg`; 
          
          try {
              const response = await fetch(cardUrl);
              const blob = await response.blob();
              
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.style.display = 'none';
              a.href = url;
              a.download = downloadFileName;
              
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);

          } catch (error) {
              console.error('Error al descargar la imagen:', error);
              document.getElementById('modal-message').innerText = '❌ Error al intentar descargar la imagen.';
              document.getElementById('error-modal').classList.remove('hidden');
              setTimeout(() => document.getElementById('error-modal').classList.add('hidden'), 3000);
          }
      };
      // ------------------------------------------------------------------

      return (
        <div className="min-h-screen text-slate-800 font-sans selection:bg-red-200">
          {/* NAVBAR */}
          <nav className="bg-white sticky top-0 z-50 border-b border-slate-200 no-print shadow-sm">
            <div className="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
              <div 
                onClick={() => { setActiveTab('home'); setSearchCode(''); setFoundPlayer(null); }}
                className="flex items-center gap-2 cursor-pointer"
              >
                {/* CAMBIO A: ESPACIO PARA EL LOGO DE BINGO APONTE
                    Reemplaza el texto "src" con la ruta de tu logo, por ejemplo:
                    src="/ruta/a/tu/logo-aponte.png"
                */}
                <img 
                src="https://raw.githubusercontent.com/AAlll33/bingosue/main/logo-aponte.png" 
                alt="" 
                className="h-10 w-auto"
                />
                <span className="font-black text-xl tracking-tight text-slate-800">Bingo<span className="text-purple-600">de prueba</span></span>
              </div>

              {user ? (
                 <button onClick={() => setActiveTab('admin')} className="text-sm font-medium text-purple-600 flex items-center gap-1">
                    <Lock size={16}/> ADMIN
                 </button>
              ) : (
                <button onClick={() => setActiveTab('admin')} className="text-sm font-medium text-slate-500 hover:text-purple-600 flex items-center gap-1">
                  <Lock size={16}/> Admin
                </button>
              )}
              
              {user && (
                 <button onClick={handleLogout} className="text-sm font-medium text-purple-500 flex items-center gap-1">
                   <LogOut size={16}/> Salir
                 </button>
              )}
            </div>
          </nav>

          <main className="max-w-5xl mx-auto p-4 md:p-8 flex flex-col items-center min-h-[80vh]">

            {/* VISTA 1: BUSCADOR */}
            {activeTab === 'home' && (
              <div className="w-full max-w-md mt-10 animate-fade-in-up text-center bg-white/70 backdrop-blur-sm p-8 rounded-2xl shadow-xl border border-slate-100 relative z-10">
                <div className="mb-8">
                  <h1 className="text-4xl font-black text-slate-900 mb-2">Busca tu Cartón</h1>
                  <p className="text-slate-500">Ingresa tu número de ticket para ver tu carta.</p>
                </div>

                <form onSubmit={handleSearch} className="bg-white p-2 rounded-2xl shadow-xl flex items-center border border-slate-100">
                  <div className="pl-4 text-slate-400"><Hash size={24} /></div>
                  <input 
                    type="text" 
                    value={searchCode}
                    onChange={(e) => setSearchCode(e.target.value)}
                    placeholder="001"
                    maxLength={3}
                    className="w-full p-4 bg-transparent outline-none text-2xl font-black text-slate-800 placeholder:text-slate-300 font-mono"
                  />
                  <button 
                    type="submit"
                    disabled={loading}
                    className="bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl font-bold transition-all disabled:opacity-50 flex items-center justify-center gap-2 w-20"
                  >
                    {loading ? <Loader2 className="animate-spin" size={24} /> : <Search size={24} />}
                  </button>
                </form>
              </div>
            )}

            {/* VISTA 2: RESULTADO */}
            {activeTab === 'result' && foundPlayer && (
              <div className="w-full animate-fade-in relative z-10">
                <div className="flex justify-between items-center mb-6 no-print bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                  <button onClick={() => { setActiveTab('home'); setFoundPlayer(null); }} className="flex items-center gap-2 text-slate-500 hover:text-slate-800">
                    <X size={18} /> Cerrar Búsqueda
                  </button>
                  <button onClick={handlePrint} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2 hover:bg-red-700">
                    <Printer size={18} /> Imprimir (Solo Imagen)
                  </button>
                </div>
                <FullTicket player={foundPlayer} />
              </div>
            )}

            {/* VISTA 3: LOGIN Y ADMIN */}
            {activeTab === 'admin' && (
              <div className="w-full max-w-4xl animate-fade-in relative z-10">
                {!user ? (
                  // FORMULARIO DE LOGIN
                  <div className="max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-xl border border-purple-50">
                    <h2 className="text-xl font-bold mb-6 text-center">Acceso Administrativo</h2>
                    {authError && <div className="bg-purple-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center">{authError}</div>}
                    <form onSubmit={handleLogin} className="space-y-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400">EMAIL</label>
                        <input 
                          type="email" 
                          required
                          className="w-full border p-3 rounded-lg outline-none focus:border-purple-500"
                          value={email}
                          onChange={(e) => setEmail(e.target.value)}
                        />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400">CONTRASEÑA</label>
                        <input 
                          type="password" 
                          required
                          className="w-full border p-3 rounded-lg outline-none focus:border-purple-500"
                          value={password}
                          onChange={(e) => setPassword(e.target.value)}
                        />
                      </div>
                      <button disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 flex justify-center">
                        {loading ? <Loader2 className="animate-spin" size={24}/> : "Entrar"}
                      </button>
                    </form>
                  </div>
                ) : (
                  // PANEL DE ADMINISTRACIÓN
                  <div className="grid lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-1">
                      <div className="bg-white p-6 rounded-2xl shadow-lg border border-purple-50 sticky top-24">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-purple-700">
                          <UserPlus size={20}/> Asignar Cartón
                        </h3>
                        <form onSubmit={handleCreatePlayer} className="space-y-4">
                          <div>
                            <label className="text-xs font-bold text-slate-400">NÚMERO DE CARTÓN (001-400)</label>
                            <input 
                              type="text" 
                              value={newId}
                              onChange={(e) => setNewId(e.target.value.replace(/[^0-9]/g, ''))} // Solo números
                              maxLength={3}
                              placeholder="001"
                              className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 font-mono font-bold text-red-700"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-bold text-slate-400">NOMBRE CLIENTE</label>
                            <input 
                              type="text" 
                              value={newName}
                              onChange={(e) => setNewName(e.target.value)}
                              placeholder="Ej: Juan Pérez"
                              required
                              className="w-full border-2 border-slate-200 rounded-lg p-2 focus:border-purple-500 outline-none"
                            />
                          </div>
                          <button disabled={actionLoading} className="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-md transition-all flex justify-center">
                            {actionLoading ? <Loader2 className="animate-spin" size={24}/> : "Asignar Cartón"}
                          </button>
                           {/* ELIMINADA LA LÍNEA QUE MOSTRABA LA RUTA DEL ARCHIVO */}
                        </form>
                      </div>
                    </div>

                    <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                      <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                        Lista de Cartones ({players.length})
                      </div>
                      <div className="max-h-[500px] overflow-y-auto p-2">
                        {players.map((p) => (
                          <div key={p.id} className="flex justify-between items-center p-3 hover:bg-purple-50 rounded-lg border-b border-slate-50">
                            <div className="flex items-center gap-3">
                              <span className="font-mono font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded text-sm">{p.id}</span>
                              <span className="font-medium">{p.name}</span>
                            </div>
                            <div className="flex gap-2">
                               {/* Botón de descarga en Admin MODIFICADO */}
                               <button onClick={() => handleDownloadAdmin(p.id, p.name)} title="Descargar Imagen" className="p-2 text-green-500 hover:bg-green-100 rounded-full"><Download size={16}/></button>
                               <button title="Ver Cartón" onClick={() => { setFoundPlayer(p); setActiveTab('result'); }} className="p-2 text-blue-500 hover:bg-blue-100 rounded-full"><Search size={16}/></button>
                               <button title="Eliminar" onClick={() => handleDelete(p.id)} className="p-2 text-red-500 hover:bg-red-100 rounded-full"><Trash2 size={16}/></button>
                            </div>
                          </div>
                        ))}
                        {players.length === 0 && <p className="text-center p-10 text-slate-400">Sin registros en la base de datos.</p>}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>
          
          {/* MODAL DE MENSAJES (Sustituto de alert()) */}
          <div id="error-modal" class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[9999] transition-opacity duration-300">
              <p id="modal-message" class="flex items-center gap-2 font-medium"></p>
          </div>

          {/* ---------------------------------------------------
              FOOTER CON INFORMACIÓN DE CONTACTO Y COPYRIGHT
              ---------------------------------------------------
          */}
          <footer class="mt-16 py-6 border-t border-slate-200 text-center text-slate-600 bg-white/70 backdrop-blur-sm relative z-10 no-print">
              <div class="max-w-5xl mx-auto px-4">
                  <p class="text-sm font-semibold mb-1 flex items-center justify-center gap-2">
                      2025 Bingo de prueba® -
                      
                      {/* ⚠️ ESPACIO PARA LOGO MASSON© ⚠️
                          REEMPLAZA LA ETIQUETA 'img' CON LA RUTA DE TU LOGO.
                          Ejemplo: <img src="./ruta/a/masson-logo.png" alt="Masson Logo" class="h-4 inline-block" /> 
                      */}
                      <span class="font-black text-black-600">
                          
                      </span>
              Todos los derechos reservados.
                  </p>
                  <p class="text-xs text-slate-500 mt-2">
                      Página creada por <span class="font-bold text-black-700">Masson©</span>. 
                      Escribe al WhatsApp <span class="font-bold text-green-600">+584226431972</span> para más información.
                  </p>
              </div>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  <script language="JavaScript">
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(event.keyCode == 123) { // Evita F12
           return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Evita Ctrl+Shift+I
           return false;
        }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Evita Ctrl+Shift+C
           return false;
        }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Evita Ctrl+U (Ver fuente)
           return false;
        }
    }
</script>
</body>
</html>
